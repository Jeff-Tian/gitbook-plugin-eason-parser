"use strict";var e;Object.defineProperty(exports,"__esModule",{value:!0}),(e=exports.TokenType||(exports.TokenType={}))[e.LeftParen=0]="LeftParen",e[e.RightParen=1]="RightParen",e[e.FunctionName=2]="FunctionName",e[e.Space=3]="Space",e[e.ARG=4]="ARG",e[e.EOF=5]="EOF";var t,r=function(e,t){return"("===e?exports.TokenType.LeftParen:")"===e?exports.TokenType.RightParen:" "===e||"\n"===e?exports.TokenType.Space:void 0===e?exports.TokenType.EOF:"("===t?exports.TokenType.FunctionName:exports.TokenType.ARG},n=function(e,t,n,i){for(var o="";r(e[t],i)===n;)o+=e[t],t++;return o},i=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.map((function(e){return Number(e)})).reduce((function(e,t){return e+t}),0)},o=new Map([["+",i],["-",function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return i.apply(void 0,t.map((function(e,t){return 0===t?e:-e})))}],["*",function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.map((function(e){return Number(e)})).reduce((function(e,t){return e*t}),1)}],["=",function(e,t){return e===t}],["else",function(e){return!0}],["define",function(){}]]),a=new Map([]),p=function(e){var t=Number(e[0][0])||e[0][0];if("NaN"===String(t))throw new Error("extracing NaN ! "+t);return t},l=function(){function e(){}var t=e.prototype;return t.tokenize=function(e){for(var t=[],i=void 0,o=0;o<e.length;o++){var a=e[o],p=r(a,i);switch(i=a,p){case exports.TokenType.LeftParen:case exports.TokenType.EOF:case exports.TokenType.RightParen:t.push([a,p]);break;case exports.TokenType.ARG:var l=n(e,o,exports.TokenType.ARG);t.push([l,p]),o+=l.length-1;break;case exports.TokenType.Space:t.push([a,p]);break;case exports.TokenType.FunctionName:var s=n(e,o,exports.TokenType.FunctionName,"(");t.push([s,p]),o+=s.length-1;break;default:throw new Error("Unexpected token: "+a)}}return t.push(["",exports.TokenType.EOF]),t},t.buildSyntaxTree=function(e){if(e){var t=this.tokenize(e);if(function(e){return 2===e.length}(t))return new h(1,exports.SyntaxNodeType.Literal,p(t));for(var r=[],n=void 0,i=void 0,o=0,a=!1,l=0;l<t.length;l++){var s=t[l];switch(s[1]){case exports.TokenType.LeftParen&&!a:if(a){var u=new h(r.length,exports.SyntaxNodeType.Expression);r.push(u),r.length>o&&(o=r.length)}else i=new h(r.length,exports.SyntaxNodeType.Expression),r.push(i),r.length>o&&(o=r.length),a=!0;break;case exports.TokenType.FunctionName:var c=new h(r.length,exports.SyntaxNodeType.Operator,s[0]);r[r.length-1].addChildren(c),a=!1;break;case exports.TokenType.ARG:var y=new h(r.length,exports.SyntaxNodeType.Literal,s[0]);r[r.length-1].addChildren(y);break;case exports.TokenType.Space:break;case exports.TokenType.RightParen:var d=r.pop();r.length>0?r[r.length-1].addChildren(d):n=d,a=!1}}if(!n)throw new Error("Unexpected Error for building syntax tree for "+e+", "+typeof e);return n.height=o,n}},t.parse=function(e){return this.buildSyntaxTree(e).eval()},e}();(t=exports.SyntaxNodeType||(exports.SyntaxNodeType={}))[t.Literal=0]="Literal",t[t.Operator=1]="Operator",t[t.Expression=2]="Expression";var s=function(e){return e instanceof h?e.children.length<=0?e.value:"("+e.children.map((function(e){if(e.type===exports.SyntaxNodeType.Literal){var t,r=o.get(e.value);return r?void 0!==r.value&&"function"==typeof r.eval?null!=(t=r.value)?t:r.eval():JSON.stringify(e):e.value}return e.value})).join(" ")+")":String(e)},u=function(e){return e.explain(1)},h=function(){function e(e,t,r){this.children=[],this.type=t,this.value=r,this.depth=e,this.height=1}var t=e.prototype;return t.addChildren=function(e){this.children.push(e)},t.simplify=function(){return this.type===exports.SyntaxNodeType.Literal||this.type===exports.SyntaxNodeType.Operator?{value:this.value,depth:this.depth}:{depth:this.depth,children:this.children.map((function(e){return e.simplify()}))}},t.toString=function(){return JSON.stringify(this.simplify(),void 0,"  ")},t.eval=function(){var e;if(this.type===exports.SyntaxNodeType.Literal)return Number(null!=(e=o.get(this.value))?e:this.value);if(this.type===exports.SyntaxNodeType.Operator)return o.get(this.value);if(!this.children[0].eval())throw new Error("Function not found! "+this.children[0].value+", "+exports.SyntaxNodeType[this.type]);return this.children[0].eval().apply(null,this.children.slice(1).map((function(e){return e.eval()})))},t.explain=function(e){var t;return this.type===exports.SyntaxNodeType.Literal?String(null!=(t=o.get(this.value))?t:this.value):this.type===exports.SyntaxNodeType.Operator?this.value:e<=this.depth+1?s(this.eval()):"("+(this.children.map((function(t){if(t.type===exports.SyntaxNodeType.Literal)return t.value;if(t.type===exports.SyntaxNodeType.Operator)return t.value;var r=t.explain(e);return null!=r?r:"^"})).join(" ")||"-")+")"},t.explainStepByStep=function(){for(var e=[this.explain(Infinity)],t=this.height;t>=1;t--)e.push(this.explain(t));return e},t.define=function(){if(this.type===exports.SyntaxNodeType.Expression&&"define"===this.children[0].value){var e=this.children[1],t=this.children[2];if(e.type!==exports.SyntaxNodeType.Literal||t.type!==exports.SyntaxNodeType.Literal){var r=e.children[0],n=e.children.slice(1);n.forEach((function(e){o.set(e.value,void 0)})),o.set(r.value,"cond"!==t.children[0].value?o.get(t.children[0].value):function(){for(var e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];n.forEach((function(e,t){o.set(e.value,r[t])}));for(var a=t.children.slice(1),p=0;p<a.length;p++){var l=a[p].children[0].eval();if(Boolean(l))return a[p].children[1].eval()}throw new Error("cond expression error!")})}else o.set(e.value,t.value)}},t.defineExplain=function(){if(this.type===exports.SyntaxNodeType.Expression&&"define"===this.children[0].value){var e=this.children[1],t=this.children[2];if(e.type!==exports.SyntaxNodeType.Literal||t.type!==exports.SyntaxNodeType.Literal){var r=e.children[0],n=e.children.slice(1);n.forEach((function(e){a.set(e.value,void 0)})),a.set(r.value,"cond"!==t.children[0].value?a.get(t.children[0].value):function(){for(var e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];n.forEach((function(e,t){o.set(e.value,r[t]),a.set(e.value,r[t])}));for(var p=t.children.slice(1),l=0;l<p.length;l++){var s=p[l].children[0].eval();if(Boolean(s))return p[l].children[1]}throw new Error("cond expression error!")})}else a.set(e.value,t.value)}},t.expand=function(){if(this.children.slice(1).every((function(e){return e.type===exports.SyntaxNodeType.Literal}))){var t=a.get(this.children[0].value);return t?t.apply(null,this.children.slice(1).map((function(e){return e.eval()}))).flatten():o.get(this.children[0].value).apply(null,this.children.slice(1).map((function(e){return e.eval()})))}var r=this;return r.children.slice(1).forEach((function(t,n){t.type!==exports.SyntaxNodeType.Literal&&(r.children[n+1]=a.get(t.children[0].value)?(new l).buildSyntaxTree(t.expand()):new e(1,exports.SyntaxNodeType.Literal,t.eval()))})),r.flatten()},t.flatten=function(){var e;return this.type===exports.SyntaxNodeType.Literal?String(null!=(e=a.get(this.value))?e:this.value):this.type===exports.SyntaxNodeType.Operator?String(this.value):["(",this.children.map((function(e){return e.flatten()})).join(" "),")"].join("")},t.expandToEnd=function(){for(var e=[],t=this,r=1;t&&t.type===exports.SyntaxNodeType.Expression&&r<100;){var n=t.expand();e.push(n),t=(new l).buildSyntaxTree(String(n)),r++}return e},e}();exports.Functions=o,exports.FunctionsForExplain=a,exports.SchemeParser=l,exports.SyntaxNode=h,exports.explains=function(e){for(var t=[],r=0;r<10;r++){var n=u(e);if("NaN"===String(n))throw new Error("explains error! "+e.children[2].toString());t.push(n),e=(new l).buildSyntaxTree(n)}return t},exports.extractLiteral=p,exports.getTokenType=r,exports.readToEnd=n,exports.stringify=s;
//# sourceMappingURL=eason-parser.cjs.production.min.js.map
